<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOMAPORT - Génération de QR Code Avancée</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
        --somaport-green: #66CC33;
        --somaport-green-dark: #4CAF50;
        --sea-blue: #0077B6;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --surface-color: #ffffff;
        --border-color: #e2e8f0;
        --radius-xl: 1rem;
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1 ), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--sea-blue), var(--somaport-green));
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.1;
            overflow-x: hidden;
        }
        .welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, var(--sea-blue), var(--somaport-green));
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; transition: opacity 0.8s ease, visibility 0.8s ease;
        }
        .welcome-screen.hidden { opacity: 0; visibility: hidden; }
        .welcome-content { text-align: center; color: white; max-width: 600px; padding: 2rem; }
        .welcome-logo {
            width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); animation: float 3s ease-in-out infinite;
        }
        .welcome-title { font-size: 3rem; font-weight: 700; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); animation: fadeInUp 1s ease 0.5s both; }
        .welcome-subtitle { font-size: 1.5rem; font-weight: 300; margin-bottom: 2rem; opacity: 0.9; animation: fadeInUp 1s ease 0.7s both; }
        .mode-selector {
            display: flex; justify-content: center; margin-bottom: 2rem;
            background: rgba(0,0,0,0.2); border-radius: 50px; padding: 0.5rem;
            animation: fadeInUp 1s ease 0.9s both;
        }
        .mode-selector input[type="radio"] { display: none; }
        .mode-selector label {
            padding: 0.8rem 1.5rem; cursor: pointer; border-radius: 50px;
            transition: all 0.3s ease; font-weight: 600; color: rgba(255,255,255,0.7);
        }
        .mode-selector input[type="radio"]:checked + label {
            background: white; color: var(--sea-blue); box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .enter-button {
            background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 1rem 2rem; font-size: 1.125rem; font-weight: 600;
            border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            backdrop-filter: blur(10px); animation: fadeInUp 1s ease 1.1s both;
        }
        .enter-button:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; display: none; opacity: 0; transition: opacity 0.8s ease; }
        .container.active { display: block; opacity: 1; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 2rem; }
        .logo { display: flex; align-items: center; color: white; font-size: 1.8rem; font-weight: 700; }
        .logo img { height: 60px; margin-right: 1rem; border-radius: 50%; }
        .nav-links a { color: white; text-decoration: none; margin-left: 1.5rem; font-weight: 500; }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .content-wrapper { background-color: var(--surface-color); padding: 2.5rem; border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); }
        .upload-section { background-color: #ECEFF1; padding: 2rem; border-radius: 1rem; text-align: center; border: 2px dashed #B0BEC5; }
        .upload-icon { font-size: 4rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .upload-section p { color: var(--text-secondary); margin-bottom: 1.5rem; }
        .file-input-label { background-color: var(--somaport-green); color: white; padding: 0.8rem 1.5rem; border-radius: 0.5rem; cursor: pointer; display: inline-block; }
        #pdf_file, #batch_pdf_files { display: none; }
        .button-group { display: flex; gap: 1rem; margin-top: 2rem; }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; flex-grow: 1; }
        .btn-primary { background-color: var(--somaport-green); color: white; }
        .btn-secondary { background-color: var(--sea-blue); color: white; }
        .sidebar { background-color: var(--surface-color); padding: 2rem; border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); }
        .sidebar h3 { color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px dashed var(--border-color); }
        .history-filename { font-weight: 500; }
        .history-status { font-size: 0.9rem; padding: 0.3rem 0.6rem; border-radius: 0.375rem; color: white; }
        .status-completed { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .stat-card { background-color: #f7f9fc; padding: 1rem; border-radius: 0.5rem; text-align: center; }
        .stat-card h4 { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .stat-card p { font-size: 1.8rem; font-weight: 700; color: var(--somaport-green); }
        .footer { text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-top: 2rem; }
        .footer a { color: white; text-decoration: none; font-weight: 500; }
        .alert { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; font-weight: 500; display: none; align-items: center; gap: 0.75rem; }
        .alert-success { background-color: #d1fae5; color: #065f46; }
        .alert-error { background-color: #fee2e2; color: #991b1b; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; position: relative; line-height: 1.6; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; border: none; background: none; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 992px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<!-- Welcome Screen -->
<div class="welcome-screen" id="welcomeScreen">
    <div class="welcome-content">
        <img src="{{ url_for('static', filename='somaport.jpg') }}" alt="Logo Somaport" class="welcome-logo">
        <h1 class="welcome-title">Bienvenue chez SOMAPORT</h1>
        <p class="welcome-subtitle">Choisissez votre mode de traitement</p>
        <div class="mode-selector">
            <input type="radio" id="modeSingle" name="uploadMode" value="single" checked>
            <label for="modeSingle"><i class="fas fa-upload"></i> Traitement Simple</label>
            <input type="radio" id="modeBatch" name="uploadMode" value="batch">
            <label for="modeBatch"><i class="fas fa-layer-group"></i> Traitement par Lot</label>
        </div>
        <button class="enter-button" id="enterAppButton">
            Continuer <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

<!-- Main Application Container -->
<div class="container" id="appContainer">
    <header class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='somaport.jpg') }}" alt="Logo Somaport">
            <span>SOMAPORT QR</span>
        </div>
        <nav class="nav-links">
             <a href="#" id="backToWelcomeLink"><i class="fas fa-home"></i> Accueil</a>
             <a href="#" id="historyLink"><i class="fas fa-history"></i> Historique</a>
        </nav>
    </header>

    <div class="main-content">
        <div class="content-wrapper">
            <section id="singleUploadSection">
                <h2>Générer un QR Code pour un PDF</h2>
                <div class="alert" id="singleUploadAlert"></div>
                <div class="upload-section" id="dropArea">
                    <i class="fas fa-file-upload upload-icon"></i>
                    <p>Glissez & déposez votre fichier PDF ici, ou</p>
                    <label for="pdf_file" class="file-input-label"><i class="fas fa-folder-open"></i> Choisir un fichier</label>
                    <input type="file" id="pdf_file" accept=".pdf">
                </div>
                <div id="fileNameDisplay" style="margin-top: 1rem; font-weight: 500;"></div>
                <div class="button-group">
                    <button class="btn btn-primary" id="uploadButton" disabled><i class="fas fa-qrcode"></i> Générer le QR Code</button>
                </div>
            </section>

            <section id="batchUploadSection">
                <h2>Générer des QR Codes par Lot</h2>
                <div class="alert" id="batchUploadAlert"></div>
                <div class="upload-section" id="batchDropArea">
                    <i class="fas fa-files upload-icon"></i>
                    <p>Glissez & déposez plusieurs fichiers PDF ici, ou</p>
                    <label for="batch_pdf_files" class="file-input-label"><i class="fas fa-folder-open"></i> Choisir des fichiers</label>
                    <input type="file" id="batch_pdf_files" accept=".pdf" multiple>
                </div>
                <div id="batchFileNamesDisplay" style="margin-top: 1rem; font-weight: 500;"></div>
                <div class="button-group">
                    <button class="btn btn-secondary" id="batchUploadButton"><i class="fas fa-cogs"></i> Générer par Lot</button>
                </div>
            </section>

            <section id="historySection">
                <h2>Historique des Traitements</h2>
                <div id="historyList"></div>
            </section>
        </div>

        <aside class="sidebar">
            <h3>Statistiques</h3>
            <div class="stats-grid">
                <div class="stat-card"><h4>Total Traités</h4><p id="totalProcessed">0</p></div>
                <div class="stat-card"><h4>Aujourd'hui</h4><p id="todayProcessed">0</p></div>
                <div class="stat-card"><h4>Dernier Temps</h4><p id="lastTime">0s</p></div>
            </div>
        </aside>
    </div>

    <footer class="footer">
        <p>&copy; 2025 SOMAPORT. Tous droits réservés. | <a href="#" id="privacyPolicyLink">Politique de Confidentialité</a></p>
    </footer>
</div>

<!-- Fenêtre Modale -->
<div class="modal-overlay" id="privacyModal">
    <div class="modal-content">
        <button class="modal-close-btn" id="closePrivacyModal">&times;</button>
        <h2>Politique de Confidentialité de SOMAPORT</h2>
        <p><strong>Dernière mise à jour : 10 août 2025</strong></p>
        <p>Chez SOMAPORT, nous respectons votre vie privée. Cette politique de confidentialité explique comment nous traitons les informations lorsque vous utilisez notre service de génération de QR code pour PDF.</p>
        <p><strong>Collecte et Utilisation des Fichiers</strong>

        Nous ne collectons aucune information personnelle identifiable. Lorsque vous téléchargez un fichier PDF pour générer un QR code, ce fichier est utilisé uniquement pour le processus de génération.</p>
        <p><strong>Stockage et Sécurité des Fichiers</strong>

        Votre vie privée est notre priorité. Les fichiers PDF que vous téléchargez sont traités de manière sécurisée et ne sont pas stockés sur nos serveurs. Ils sont supprimés immédiatement après la génération du QR code. Nous ne conservons aucune copie de vos documents.</p>
        <p><strong>Partage d'Informations</strong>

        Nous ne partageons, ne vendons ni ne louons vos informations ou le contenu de vos fichiers à des tiers.</p>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Éléments du DOM ---
    const welcomeScreen = document.getElementById('welcomeScreen');
    const enterAppButton = document.getElementById('enterAppButton');
    const appContainer = document.getElementById('appContainer');

    const singleUploadSection = document.getElementById('singleUploadSection');
    const batchUploadSection = document.getElementById('batchUploadSection');
    const historySection = document.getElementById('historySection');
    const allContentSections = [singleUploadSection, batchUploadSection, historySection];

    const historyLink = document.getElementById('historyLink');
    const backToWelcomeLink = document.getElementById('backToWelcomeLink');

    const pdfFileInput = document.getElementById('pdf_file');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const uploadButton = document.getElementById('uploadButton');
    const singleUploadAlert = document.getElementById('singleUploadAlert');

    const batchPdfFileInput = document.getElementById('batch_pdf_files');
    const batchFileNamesDisplay = document.getElementById('batchFileNamesDisplay');
    const batchUploadButton = document.getElementById('batchUploadButton');
    const batchUploadAlert = document.getElementById('batchUploadAlert');

    const historyList = document.getElementById('historyList');
    const loadingOverlay = document.getElementById('loadingOverlay');

    const privacyPolicyLink = document.getElementById('privacyPolicyLink');
    const privacyModal = document.getElementById('privacyModal');
    const closePrivacyModal = document.getElementById('closePrivacyModal');

    // --- Logique d'Initialisation ---
    enterAppButton.addEventListener('click', () => {
        const selectedMode = document.querySelector('input[name="uploadMode"]:checked').value;

        welcomeScreen.classList.add('hidden');
        appContainer.classList.remove('hidden');
        appContainer.classList.add('active');

        if (selectedMode === 'single') {
            showSection(singleUploadSection);
        } else {
            showSection(batchUploadSection);
        }
        fetchStats();
    });

    // --- Logique de Navigation ---
    function showSection(sectionToShow) {
        allContentSections.forEach(section => {
            section.style.display = 'none';
        });
        sectionToShow.style.display = 'block';
    }

    historyLink.addEventListener('click', (e) => {
        e.preventDefault();
        showSection(historySection);
        fetchHistory();
    });

    backToWelcomeLink.addEventListener('click', (e) => {
        e.preventDefault();
        appContainer.classList.remove('active');
        appContainer.classList.add('hidden');
        welcomeScreen.classList.remove('hidden');
    });

    // --- Logique de la Modale de Confidentialité ---
    privacyPolicyLink.addEventListener('click', (e) => { e.preventDefault(); privacyModal.style.display = 'flex'; });
    closePrivacyModal.addEventListener('click', () => { privacyModal.style.display = 'none'; });
    privacyModal.addEventListener('click', (e) => { if (e.target === privacyModal) { privacyModal.style.display = 'none'; } });

    // --- Logique de Téléchargement Simple ---
    pdfFileInput.addEventListener('change', () => updateFileNameDisplay(pdfFileInput, fileNameDisplay, singleUploadAlert, uploadButton));
    uploadButton.addEventListener('click', handleSingleUpload);

    // --- Logique de Téléchargement par Lot ---
    batchPdfFileInput.addEventListener('change', () => {
        if (batchPdfFileInput.files.length > 0) {
            batchFileNamesDisplay.textContent = `${batchPdfFileInput.files.length} fichiers sélectionnés`;
        } else {
            batchFileNamesDisplay.textContent = '';
        }
    });
    batchUploadButton.addEventListener('click', handleBatchUpload);

    // --- Fonctions ---
    function updateFileNameDisplay(input, display, alertElement, buttonElement) {
        if (input.files.length > 0) {
            const file = input.files[0];
            const fileSizeKB = (file.size / 1024).toFixed(2);
            display.textContent = `${file.name} (${fileSizeKB} KB)`;

            if (file.size > 3 * 1024) {
                showAlert(alertElement, `Erreur : Le fichier dépasse la limite de 3 KB.`, 'error');
                buttonElement.disabled = true;
            } else {
                showAlert(alertElement, '', 'success', true);
                buttonElement.disabled = false;
            }
        } else {
            display.textContent = '';
            buttonElement.disabled = true;
        }
    }

    async function handleSingleUpload() {
        const file = pdfFileInput.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('pdf_file', file);
        showLoading(true);
        try {
            const response = await fetch('/upload', { method: 'POST', body: formData });
            if (response.ok) {
                const blob = await response.blob();
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `QR_${file.name}`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(downloadUrl);
                const processingTime = response.headers.get('X-Processing-Time');
                if (processingTime) {
                    document.getElementById('lastTime').textContent = `${processingTime}s`;
                }
                showAlert(singleUploadAlert, 'QR Code généré et téléchargé avec succès !', 'success');
                pdfFileInput.value = '';
                fileNameDisplay.textContent = '';
                uploadButton.disabled = true;
                fetchStats();
            } else {
                const errorData = await response.json();
                showAlert(singleUploadAlert, `Erreur: ${errorData.error || 'Une erreur est survenue.'}`, 'error');
            }
        } catch (error) {
            showAlert(singleUploadAlert, 'Erreur de connexion au serveur.', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function handleBatchUpload() {
        const files = batchPdfFileInput.files;
        if (files.length === 0) {
            showAlert(batchUploadAlert, 'Veuillez sélectionner au moins un fichier PDF.', 'error');
            return;
        }
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('pdf_files', files[i]);
        }
        showLoading(true, 'Traitement par lot en cours...');
        try {
            const response = await fetch('/batch_upload', { method: 'POST', body: formData });
            if (response.ok) {
                const blob = await response.blob();
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'fichiers_traites.zip';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(downloadUrl);
                showAlert(batchUploadAlert, 'Fichiers traités et téléchargés avec succès !', 'success');
                batchPdfFileInput.value = '';
                batchFileNamesDisplay.textContent = '';
                fetchStats();
            } else {
                const errorData = await response.json();
                showAlert(batchUploadAlert, `Erreur: ${errorData.error || 'Une erreur est survenue.'}`, 'error');
            }
        } catch (error) {
            showAlert(batchUploadAlert, 'Erreur de connexion au serveur.', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function fetchStats() {
        try {
            const response = await fetch('/stats');
            const data = await response.json();
            if (response.ok) {
                document.getElementById('totalProcessed').textContent = data.total_completed;
                document.getElementById('todayProcessed').textContent = data.today_completed;
            }
        } catch (error) { console.error('Erreur de chargement des stats:', error); }
    }

    async function fetchHistory() {
        try {
            const response = await fetch('/history');
            const data = await response.json();
            historyList.innerHTML = '';
            if (data.files && data.files.length > 0) {
                data.files.forEach(file => {
                    const item = document.createElement('div');
                    item.classList.add('history-item');
                    item.innerHTML = `<span class="history-filename">${file.filename}</span><span class="history-status status-${file.status}">${file.status}</span>`;
                    historyList.appendChild(item);
                });
            } else {
                historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Aucun historique disponible.</p>';
            }
        } catch (error) {
            historyList.innerHTML = '<p style="text-align: center; color: red;">Erreur de chargement de l\'historique.</p>';
        }
    }

    function showAlert(element, message, type, hide = false) {
        if (hide) { element.style.display = 'none'; return; }
        element.textContent = message;
        element.className = `alert alert-${type}`;
        element.style.display = 'flex';
    }

    function showLoading(isLoading) {
        loadingOverlay.style.display = isLoading ? 'flex' : 'none';
    }
});
</script>
</body>
</html>
