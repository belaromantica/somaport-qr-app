<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOMAPORT - Génération de QR Code Avancée</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --somaport-green: #66CC33; --somaport-green-dark: #4CAF50; --sea-blue: #0077B6;
            --wind-gray: #ECEFF1; --text-primary: #1e293b; --text-secondary: #64748b;
            --background-color: #f8fafc; --surface-color: #ffffff; --border-color: #e2e8f0;
            --success-color: #10b981; --error-color: #ef4444; --radius-md: 0.5rem; --radius-lg: 0.75rem; --radius-xl: 1rem;
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1 ), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--sea-blue), var(--somaport-green)); min-height: 100vh; color: var(--text-primary); }
        .container { max-width: 1000px; margin: 2rem auto; padding: 2rem; }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; background-color: var(--surface-color); padding: 2.5rem; border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); }
        .upload-section { text-align: center; }
        .upload-box { background-color: #f7f9fc; padding: 2rem; border-radius: var(--radius-lg); border: 2px dashed #dce4f0; }
        .upload-box i { font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .file-input-label { background-color: var(--somaport-green); color: white; padding: 0.8rem 1.5rem; border-radius: var(--radius-md); cursor: pointer; display: inline-block; transition: background-color 0.3s; }
        .file-input-label:hover { background-color: var(--somaport-green-dark); }
        #pdf_file, #batch_pdf_files { display: none; }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: var(--radius-md); font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 1.5rem; }
        .btn-primary { background-color: var(--somaport-green); color: white; }
        .sidebar { padding-top: 1rem; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; }
        .stat-card { background-color: #f7f9fc; padding: 1rem; border-radius: var(--radius-md); text-align: center; }
        .stat-card h4 { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .stat-card p { font-size: 1.8rem; font-weight: 700; color: var(--somaport-green); }
        .footer { text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; }
        .footer a { color: white; text-decoration: none; font-weight: 500; }
        .footer a:hover { text-decoration: underline; }
        .alert { padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; font-weight: 500; }
        .alert-error { background-color: #fee2e2; color: #991b1b; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 2rem; border-radius: var(--radius-lg); max-width: 600px; width: 90%; position: relative; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; border: none; background: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container" id="appContainer">
        <div class="main-content">
            <!-- Zone de contenu principal -->
            <div>
                <section id="singleUploadSection">
                    <div class="upload-section">
                        <h2>Générer un QR Code pour un PDF</h2>
                        <div class="alert" id="singleUploadAlert" style="display: none;"></div>
                        <div class="upload-box" id="dropArea">
                            <i class="fas fa-file-upload"></i>
                            <p>Glissez & déposez votre fichier PDF ici, ou</p>
                            <label for="pdf_file" class="file-input-label"><i class="fas fa-folder-open"></i> Choisir un fichier</label>
                            <input type="file" id="pdf_file" accept=".pdf">
                        </div>
                        <div id="fileNameDisplay" style="margin-top: 1rem; font-weight: 500;"></div>
                        <button class="btn btn-primary" id="uploadButton" disabled><i class="fas fa-qrcode"></i> Générer le QR Code</button>
                    </div>
                </section>
            </div>

            <!-- Barre latérale avec les statistiques -->
            <aside class="sidebar">
                <h3>Statistiques</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total Traités</h4>
                        <p id="totalProcessed">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Aujourd'hui</h4>
                        <p id="todayProcessed">0</p>
                    </div>
                </div>
                 <div class="stat-card" style="margin-top: 1rem;">
                    <h4>Dernier Temps</h4>
                    <p id="lastTime">0s</p>
                </div>
            </aside>
        </div>
        <footer class="footer">
            <p>&copy; 2025 SOMAPORT. Tous droits réservés. | <a href="#" id="privacyPolicyLink">Politique de Confidentialité</a></p>
        </footer>
    </div>

    <!-- Fenêtre Modale pour la Politique de Confidentialité -->
    <div class="modal-overlay" id="privacyModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closePrivacyModal">&times;</button>
            <h2>Politique de Confidentialité de SOMAPORT</h2>
            <p><strong>Dernière mise à jour : 11 août 2025</strong></p>
            <p>Nous ne collectons aucune information personnelle. Lorsque vous téléchargez un fichier PDF, il est utilisé uniquement pour générer le QR code et est supprimé de nos serveurs immédiatement après. Nous ne stockons ni ne partageons vos fichiers.</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const appContainer = document.getElementById('appContainer');
    const pdfFileInput = document.getElementById('pdf_file');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const uploadButton = document.getElementById('uploadButton');
    const singleUploadAlert = document.getElementById('singleUploadAlert');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const privacyPolicyLink = document.getElementById('privacyPolicyLink');
    const privacyModal = document.getElementById('privacyModal');
    const closePrivacyModal = document.getElementById('closePrivacyModal');

    // --- Initialisation ---
    fetchStats();

    // --- Logique de Téléchargement ---
    pdfFileInput.addEventListener('change', () => updateFileNameDisplay(pdfFileInput, fileNameDisplay));
    uploadButton.addEventListener('click', handleUpload);

    // --- Logique de la modale de confidentialité ---
    privacyPolicyLink.addEventListener('click', (e) => { e.preventDefault(); privacyModal.style.display = 'flex'; });
    closePrivacyModal.addEventListener('click', () => { privacyModal.style.display = 'none'; });
    privacyModal.addEventListener('click', (e) => { if (e.target === privacyModal) { privacyModal.style.display = 'none'; } });

    // --- Fonctions ---
    function updateFileNameDisplay(input, display) {
        if (input.files.length > 0) {
            const file = input.files[0];
            const fileSizeKB = (file.size / 1024).toFixed(2);
            display.textContent = `${file.name} (${fileSizeKB} KB)`;

            if (file.size > 3 * 1024) {
                showAlert(singleUploadAlert, `Erreur : Le fichier dépasse la limite de 3 KB.`, 'error');
                uploadButton.disabled = true;
            } else {
                uploadButton.disabled = false;
                singleUploadAlert.style.display = 'none'; // Cacher l'alerte si le fichier est valide
            }
        } else {
            display.textContent = '';
            uploadButton.disabled = true;
        }
    }

    async function handleUpload() {
        const file = pdfFileInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('pdf_file', file);
        showLoading(true);

        try {
            const response = await fetch('/upload', { method: 'POST', body: formData });
            if (response.ok) {
                const blob = await response.blob();
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `QR_${file.name}`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(downloadUrl);

                const processingTime = response.headers.get('X-Processing-Time');
                if (processingTime) {
                    document.getElementById('lastTime').textContent = `${processingTime}s`;
                }
                showAlert(singleUploadAlert, 'QR Code généré et téléchargé avec succès !', 'success');
                pdfFileInput.value = '';
                fileNameDisplay.textContent = '';
                uploadButton.disabled = true;
                fetchStats(); // Mettre à jour les stats après un succès
            } else {
                const errorData = await response.json();
                showAlert(singleUploadAlert, `Erreur: ${errorData.error || 'Une erreur est survenue.'}`, 'error');
            }
        } catch (error) {
            showAlert(singleUploadAlert, 'Erreur de connexion au serveur.', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function fetchStats() {
        try {
            const response = await fetch('/stats');
            const data = await response.json();
            if (response.ok) {
                document.getElementById('totalProcessed').textContent = data.total_completed;
                document.getElementById('todayProcessed').textContent = data.today_completed;
            }
        } catch (error) {
            console.error('Erreur de chargement des stats:', error);
        }
    }

    function showAlert(element, message, type) {
        element.textContent = message;
        element.className = `alert alert-${type}`;
        element.style.display = 'block';
    }

    function showLoading(isLoading) {
        loadingOverlay.style.display = isLoading ? 'flex' : 'none';
    }
});
</script>
</body>
</html>
